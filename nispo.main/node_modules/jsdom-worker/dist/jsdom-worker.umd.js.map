{"version":3,"file":"jsdom-worker.umd.js","sources":["../node_modules/mitt/dist/mitt.mjs","../node_modules/uuid-v4/index.js","../src/index.js"],"sourcesContent":["export default function(n){return{all:n=n||new Map,on:function(t,e){var i=n.get(t);i?i.push(e):n.set(t,[e])},off:function(t,e){var i=n.get(t);i&&(e?i.splice(i.indexOf(e)>>>0,1):n.set(t,[]))},emit:function(t,e){var i=n.get(t);i&&i.slice().map(function(n){n(e)}),(i=n.get(\"*\"))&&i.slice().map(function(n){n(t,e)})}}}\n//# sourceMappingURL=mitt.mjs.map\n","\nexports = module.exports = function() {\n\tvar ret = '', value;\n\tfor (var i = 0; i < 32; i++) {\n\t\tvalue = exports.random() * 16 | 0;\n\t\t// Insert the hypens\n\t\tif (i > 4 && i < 21 && ! (i % 4)) {\n\t\t\tret += '-';\n\t\t}\n\t\t// Add the next random character\n\t\tret += (\n\t\t\t(i === 12) ? 4 : (\n\t\t\t\t(i === 16) ? (value & 3 | 8) : value\n\t\t\t)\n\t\t).toString(16);\n\t}\n\treturn ret;\n};\n\nvar uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/;\nexports.isUUID = function(uuid) {\n\treturn uuidRegex.test(uuid);\n};\n\nexports.random = function() {\n\treturn Math.random();\n};\n\n","import mitt from 'mitt';\nimport uuid from 'uuid-v4';\nimport fetch, { Response } from 'node-fetch';\n\n// eslint-disable-next-line no-undef\n\nconst self = /** @type {globalThis} */ (\n\ttypeof global === 'object'\n\t\t? global\n\t\t: typeof globalThis === 'object'\n\t\t? globalThis\n\t\t: this\n);\n\n// @ts-ignore-next-line\nif (!self.URL) self.URL = {};\n\n// @ts-ignore\nlet objects = /** @type {Map<any, string>} */ (self.URL.$$objects);\n\nif (!objects) {\n\tobjects = new Map();\n\t// @ts-ignore\n\tself.URL.$$objects = objects;\n\tself.URL.createObjectURL = blob => {\n\t\tlet id = uuid();\n\t\tobjects[id] = blob;\n\t\treturn `blob:http://localhost/${id}`;\n\t};\n}\n\nif (!self.fetch || !('jsdomWorker' in self.fetch)) {\n\tlet oldFetch = self.fetch || fetch;\n\tself.fetch = function (url, opts) {\n\t\tlet _url = typeof url === 'object' ? url.url || url.href : url;\n\t\tif (_url.match(/^blob:/)) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tlet fr = new FileReader();\n\t\t\t\tfr.onload = () => {\n\t\t\t\t\tlet Res = self.Response || Response;\n\t\t\t\t\tresolve(new Res(fr.result, { status: 200, statusText: 'OK' }));\n\t\t\t\t};\n\t\t\t\tfr.onerror = () => {\n\t\t\t\t\treject(fr.error);\n\t\t\t\t};\n\t\t\t\tlet id = _url.match(/[^/]+$/)[0];\n\t\t\t\tfr.readAsText(objects[id]);\n\t\t\t});\n\t\t}\n\t\treturn oldFetch.call(this, url, opts);\n\t};\n\tObject.defineProperty(self.fetch, 'jsdomWorker', {\n\t\tconfigurable: true,\n\t\tvalue: true,\n\t});\n}\n\n// @ts-ignore\nif (!self.document) self.document = {};\n\nfunction Event(type) {\n\tthis.type = type;\n}\nEvent.prototype.initEvent = Object;\nif (!self.document.createEvent) {\n\tself.document.createEvent = function (type) {\n\t\tlet Ctor = global[type] || Event;\n\t\treturn new Ctor(type);\n\t};\n}\n\n// @ts-ignore\nself.Worker = Worker;\n\n/**\n * @param {string | URL} url\n * @param {object} [options = {}]\n */\nfunction Worker(url, options) {\n\tlet getScopeVar;\n\t/** @type {any[] | null} */\n\tlet messageQueue = [];\n\tlet inside = mitt();\n\tlet outside = mitt();\n\tlet terminated = false;\n\tlet scope = {\n\t\tonmessage: null,\n\t\tdispatchEvent: inside.emit,\n\t\taddEventListener: inside.on,\n\t\tremoveEventListener: inside.off,\n\t\tpostMessage(data) {\n\t\t\toutside.emit('message', { data });\n\t\t},\n\t\tfetch: self.fetch,\n\t\timportScripts() {},\n\t};\n\tinside.on('message', e => {\n\t\tif (terminated) return;\n\t\tlet f = scope.onmessage || getScopeVar('onmessage');\n\t\tif (f) f.call(scope, e);\n\t});\n\tthis.addEventListener = outside.on;\n\tthis.removeEventListener = outside.off;\n\tthis.dispatchEvent = outside.emit;\n\toutside.on('message', e => {\n\t\tif (this.onmessage) this.onmessage(e);\n\t});\n\tthis.onmessage = null;\n\tthis.postMessage = data => {\n\t\tif (terminated) return;\n\t\tif (messageQueue != null) messageQueue.push(data);\n\t\telse inside.emit('message', { data });\n\t};\n\tthis.terminate = () => {\n\t\tconsole.warn('Worker.prototype.terminate() not supported in jsdom-worker.');\n\t\tterminated = true;\n\t\tmessageQueue = null;\n\t};\n\tself\n\t\t.fetch(url)\n\t\t.then(r => r.text())\n\t\t.then(code => {\n\t\t\tlet vars = 'var self=this,global=self';\n\t\t\tfor (let k in scope) vars += `,${k}=self.${k}`;\n\t\t\tgetScopeVar = Function(\n\t\t\t\tvars +\n\t\t\t\t\t';\\n' +\n\t\t\t\t\tcode +\n\t\t\t\t\t'\\nreturn function(n){return n==\"onmessage\"?onmessage:null;}'\n\t\t\t).call(scope);\n\t\t\tlet q = messageQueue;\n\t\t\tmessageQueue = null;\n\t\t\tif (q) q.forEach(this.postMessage);\n\t\t})\n\t\t.catch(e => {\n\t\t\toutside.emit('error', e);\n\t\t\tconsole.error(e);\n\t\t});\n}\n"],"names":["mitt","n","all","Map","on","t","e","i","get","push","set","off","splice","indexOf","emit","slice","map","exports","module","value","ret","random","toString","uuidRegex","isUUID","uuid","test","Math","self","global","globalThis","this","URL","$$objects","objects","createObjectURL","blob","id","fetch","oldFetch","url","opts","_url","href","match","resolve","reject","fr","FileReader","onload","Response","result","status","statusText","onerror","error","readAsText","call","Object","defineProperty","configurable","Event","type","document","prototype","initEvent","createEvent","Worker","options","getScopeVar","messageQueue","inside","outside","terminated","scope","onmessage","dispatchEvent","addEventListener","removeEventListener","postMessage","data","importScripts","f","terminate","console","warn","then","r","text","code","vars","k","Function","q","forEach","catch"],"mappings":"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"}